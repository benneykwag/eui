<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='eui-grid-Merge'>/***
</span> * Colspan, Rowspan을 지원하는 그리드.
 */
Ext.define(&#39;eui.grid.Merge&#39;, {
    extend: &#39;Ext.panel.Table&#39;,
    requires: [
        &#39;eui.view.Merge&#39;
    ],
    alias: [&#39;widget.mergegrid&#39;],
<span id='eui-grid-Merge-property-viewType'>    viewType: &#39;mergetableview&#39;,
</span>
<span id='eui-grid-Merge-property-lockable'>    lockable: false,
</span><span id='eui-grid-Merge-property-columnLines'>    columnLines: true,
</span>
<span id='eui-grid-Merge-property-sortableColumns'>    sortableColumns: false,
</span>
<span id='eui-grid-Merge-cfg-rowLines'>    /**
</span>     * @cfg {Boolean} rowLines False to remove row line styling
     */
    rowLines: true,

    // Columns config is required in Grid
<span id='eui-grid-Merge-cfg-columns'>    /**
</span>     * @cfg {Ext.grid.column.Column[]/Object} columns (required)
     * @inheritdoc
     */

<span id='eui-grid-Merge-event-beforereconfigure'>    /**
</span>     * @event beforereconfigure
     * Fires before a reconfigure to enable modification of incoming Store and columns.
     * @param {Ext.grid.Panel} this
     * @param {Ext.data.Store} store The store that was passed to the {@link #method-reconfigure} method
     * @param {Object[]} columns The column configs that were passed to the {@link #method-reconfigure} method
     * @param {Ext.data.Store} oldStore The store that will be replaced
     * @param {Ext.grid.column.Column[]} oldColumns The column headers that will be replaced.
     */

<span id='eui-grid-Merge-event-reconfigure'>    /**
</span>     * @event reconfigure
     * Fires after a reconfigure.
     * @param {Ext.grid.Panel} this
     * @param {Ext.data.Store} store The store that was passed to the {@link #method-reconfigure} method
     * @param {Object[]} columns The column configs that were passed to the {@link #method-reconfigure} method
     * @param {Ext.data.Store} oldStore The store that was replaced
     * @param {Ext.grid.column.Column[]} oldColumns The column headers that were replaced.
     */

    getTempStore: function () {
        var me = this,
            rStore = this.store;
        if (!me.tempStore) {
            me.tempStore = Ext.create(&#39;Ext.data.Store&#39;, {
                model: &#39;Eui.sample.model.Base&#39;,
                sorters: [
                        me.lastMergeColumn + &#39;key&#39;
                ]
            });
            rStore.each(function (model) {
                me.tempStore.add(model.copy());
            });
        }
        return me.tempStore;
    },
<span id='eui-grid-Merge-property-cls'>    cls: &#39;stat-tdstyle&#39;,
</span>
<span id='eui-grid-Merge-property-firstMergeColspan'>    firstMergeColspan : 3,
</span>
<span id='eui-grid-Merge-method-addTotoalRow'>    addTotoalRow: function () {
</span>        var rStore = this.store;
        var store = this.getTempStore();
        var me = this;
        var col = me.groupFields[0].field;
        var retObj = {};
        retObj[col] = &#39;합&#39;;

        var colArray = Ext.Array.merge(Ext.pluck(me.groupFields, &#39;field&#39;), me.lastMergeColumn);
        retObj[col + &#39;colspan&#39;] = colArray.length;
        Ext.each(colArray, function (v, z) {
            if(z &gt; 0){
                retObj[v+&#39;hidden&#39;] = true;
            }
        });

        Ext.each(me.sumFields, function (sumcol) {
            retObj[sumcol] = store.sum(sumcol);
        })

        rStore.add(retObj);
    },

<span id='eui-grid-Merge-method-generaRow'>    generaRow: function (rStore, groupField, scol, values) {
</span>        var me = this;
        for (var test in values) {  // 그룹핑한 갯수.
<span id='eui-grid-Merge-property-div'>            /***
</span>             * convert 와 sum을 함께 사용할 경우.
             * 수입@수입@ -&gt; 중복 현상 보정.
             * @type {Array}
             */
            var div = test.split(&#39;@&#39;);
            if(div[0] === div[1]){
               div =  div.slice(1,div.length)
            }

            var lastMergeColumnKey = me.lastMergeColumn;
            var findRecord = rStore.findRecord(lastMergeColumnKey, div.join(&#39;@&#39;)+&#39;@합&#39;);
            if (findRecord) {
                findRecord.data[scol] = values[test];
            }
        }
    },

<span id='eui-grid-Merge-property-listeners'>    listeners: {
</span>        render: function () {
            var rStore = this.store;
            var me = this;
            rStore.on(&#39;load&#39;, function () {
                rStore.suspendEvents();

                var store = me.getTempStore();
                me.addTotoalRow();

                Ext.each(me.groupFields, function (groupColumn, idx) {
                    store.group(groupColumn.field);

                    var values = store.sum(me.sumFields[0], true);

                    for (var test in values) {  // 그룹핑한 갯수.
                        var retObj = {};
                        var colArray = Ext.Array.merge(Ext.pluck(me.groupFields, &#39;field&#39;), me.lastMergeColumn);
                        var i = 0;
                        Ext.each(colArray, function (v, z) {
                            var recValue  = test.split(&#39;@&#39;)[z+i];
                            if(!recValue){
                                recValue = &#39;합&#39;;
                            }
                            retObj[v] = recValue;

                            var colConfig = groupColumn.mergeConfig[z];
                            if (groupColumn.mergeConfig[z]) {
                                retObj[colConfig.field+colConfig.cond] = colConfig.value;
                            }
                            i++;
                        });
                        rStore.add(retObj)
                    }

                    // 합계를 계산할 필드로
                    Ext.each(me.sumFields, function (scol, sIdx) {
                        var testObj = {};
                        var values2 = store.sum(scol, true);
                        me.generaRow(rStore, groupColumn, scol, values2);
                    });
                });

                rStore.resumeEvents();
                me.callMerge(rStore);
            });
        }
    },


<span id='eui-grid-Merge-method-callMerge'>    /***
</span>     * 중복된 셀값을 좌우로 합친다.
     * @param rStore
     */
    callMerge: function (rStore) {
        var me = this;

        Ext.each(me.groupFields, function (mergecol, idx) {
            var mergeKeyCol = mergecol.field;


            rStore.group(mergeKeyCol);
            var cols = rStore.count(mergeKeyCol);

            for (var test in cols) {

                var sumVar = test.split(&#39;@&#39;)[1];

                var rowIdx = rStore.findExact(mergeKeyCol, test);
                var value = cols[test];

                var recs = rStore.getRange(rowIdx, rowIdx + value - 1);
                recs[0].data[mergecol.field + &#39;rowspan&#39;] = value;

                Ext.each(recs, function (item, idx) {
                    if (idx &gt; 0) {
                        item.data[mergecol.field + &#39;hidden&#39;] = true;
                    }
                });
            }
        })
        rStore.group(null);
        rStore.sort([ // #5
            { property: me.lastMergeColumn, direction: &#39;ASC&#39;} // #5
        ]);

        me.getView().refresh();
    }

});</pre>
</body>
</html>
